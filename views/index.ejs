<!doctype html>
<html lang="en">
  <%- include('head') %>
  <body>
    <div id="container">
      <%- include('actionBar') %>
      <%- include('defaultContent') %>
      <div id="streams-container">
        &nbsp;
      </div>
    </div>

    <div id="stream-manager">
      <%- include('streamManagerModal') %>
    </div>    

    <%- include('newStreamTemplate') %>
    <%- include('psodModal') %>
  
    <script src="/js/pwa.js"></script>

    <script type="text/javascript">
      const streamsModal = document.getElementById('streams-modal');
      const manageBtnActual = document.getElementById('manage-btn-actual');
      const saveBtn = document.getElementById('save-btn');
      const newStreamField = document.getElementById('new_stream');
      const addStreamBtn = document.getElementById('add-stream-btn');
      const streamManagerDefaultContent = document.getElementById('streams-manager-default-content');

      window.addEventListener('DOMContentLoaded', (event) => {
        ManyTwitch.streams.setStreams('<%= streamsFromParms %>'); // init session storage item.
        ManyTwitch.streams.update();
      });

      streamsModal.addEventListener('shown.bs.modal', (event) => {

        Array.from(document.getElementsByClassName('streams-modal-table-tr')).forEach(element => {
          element.remove();
        });

        Array.from(ManyTwitch.streams.getStreams()).forEach(element => {
          ManyTwitch.manager.addToTable(element);
        });

        newStreamField.focus();

        if (ManyTwitch.util.streamCount() == 0) {
          addStreamBtn.setAttribute('disabled', 'disabled');
          saveBtn.setAttribute('disabled', 'disabled');
          streamManagerDefaultContent.style.display = 'block';
        } else {
          saveBtn.removeAttribute('disabled');
          streamManagerDefaultContent.style.display = 'none';
        }

      });

      streamsModal.addEventListener('hidden.bs.modal', (event) => {
        newStreamField.value = '';
        addStreamBtn.setAttribute('disabled', 'disabled');
      });

      saveBtn.addEventListener('click', (event) => {

        let streamsList = document.getElementsByClassName('streams-modal-table-tr');
        let streams = ManyTwitch.streams.getStreams();
        let newStreams = [];
        const orderChangedElement = document.getElementById('order-changed');

        if (orderChangedElement.value == 'true') {
          console.log('Streams have been re-ordered. Resetting...');
          ManyTwitch.streams.setStreams('');
          streams = ManyTwitch.streams.getStreams(); // reset our var.
        }

        Array.from(streamsList).forEach(element => {
          let streamName = element.dataset.streamName;
          let streamCheckbox = document.getElementById(`streams_${streamName}`);
          if (streamCheckbox.checked) {
            newStreams.push(streamName);
          } else {
            element.remove();
          }
        });

        ManyTwitch.streams.setStreams(newStreams.join(','));
        ManyTwitch.streams.update(orderChangedElement.value);
        orderChangedElement.value = 'false';
      });

      newStreamField.addEventListener('paste', (event) => {
        if ($(this).length < 1) {
          addStreamBtn.setAttribute('disabled', 'disabled');
        } else {
          addStreamBtn.removeAttribute('disabled');
        }
      });

    </script>

    <script defer src="/js/all.min.js"></script>

    <%- include('analytics') %>
  </body>
</html>