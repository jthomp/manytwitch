<!doctype html>
<html lang="en">
  <%- include('head') %>
  <body>
    <div id="container">

      <div id="manage-btn">
        <button id='manage-btn-actual'
                type='button'
                class='btn btn-sm btn-purple'
                data-bs-toggle='modal'
                data-bs-target='#streams-modal'
                title='Manage the streams you are currently watching.'>
          <i class='fas fa-tv'></i>
        </button>
      </div>

      <%- include('defaultContent') %>

      <div id="streams"></div>
      <div class="clearfix"></div>
    </div>

    <div id="stream-manager">
      <%- include('streamManagerModal') %>
    </div>    

    <%- include('newStreamTemplate') %>
    <%- include('changelogModal') %>
    <%- include('privacyModal') %>
    <%- include('psodModal') %>
  
    <script src="/js/pwa.js"></script>

    <script type='text/javascript'>

      let streamsModal = document.getElementById('streams-modal');
      let manageBtnActual = document.getElementById('manage-btn-actual');
      let saveBtn = document.getElementById('save-btn');
      let newStreamField = document.getElementById('new_stream');

      document.addEventListener('DOMContentLoaded', (event) => {
        ManyTwitch.streams.setStreams('<%= streamsFromParms %>'); // init session storage item.
        ManyTwitch.streams.update();
      });


      // manageBtnActual.addEventListener('mouseenter', function(event) {
      //   $(this).fadeTo('normal', 1.0, function() {
      //     $(this).html("<i class='fas fa-tv'></i>&nbsp;&nbsp;Streams");
      //   });
      // });

      // manageBtnActual.addEventListener('mouseleave', function(event) {
      //   $(this).fadeTo('normal', 0.5, function() {
      //     $(this).html("<i class='fas fa-tv'></i>");
      //   });
      // });

      streamsModal.addEventListener('shown.bs.modal', function(event) {

        let addStreamBtn = document.getElementById('add-stream-btn');

        $('#streams-list tr').remove();

        Array.from(ManyTwitch.streams.getStreams()).forEach(element => {
          ManyTwitch.manager.addToTable(element);
        });

        newStreamField.focus();

        if (ManyTwitch.util.streamCount() < 1) {
          addStreamBtn.setAttribute('disabled', 'disabled');
          saveBtn.setAttribute('disabled', 'disabled');
        } else {
          saveBtn.removeAttribute('disabled');
        }

      });

      streamsModal.addEventListener('hidden.bs.modal', function(event) {
        newStreamField.value = '';
        document.getElementById('add-stream-btn').setAttribute('disabled', 'disabled');
      });

      $('#streams-modal #save-btn').on('click', function() {

        let streamsList = document.getElementsByClassName('streams-modal-table-tr');
        let streams = ManyTwitch.streams.getStreams();
        let newStreams = [];

        Array.from(streamsList).forEach(element => {
          let streamName = element.dataset.streamName;
          if (element.checked) {
            newStreams.push(streamName);
          } else {
            element.remove();
          }
        });

        ManyTwitch.streams.setStreams(newStreams.join(','));
        ManyTwitch.streams.update();
      });

      newStreamField.addEventListener('paste', function(event) {
        if ($(this).length < 1) {
          addStreamBtn.setAttribute('disabled', 'disabled');
        } else {
          addStreamBtn.removeAttribute('disabled');
        }
      });
    </script>

    <%- include('analytics') %>
  </body>
</html>