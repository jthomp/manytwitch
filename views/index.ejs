<!doctype html>
<html lang="en">
  <%- include("head") %>
  <body data-env="<%- env %>">
    <div id="container">
      <noscript>
        <div class="alert alert-warning text-center">ManyTwitch works best with JavaScript enabled</div>
      </noscript>
      <%- include("mainActionBar") %>
      <%- include("defaultContent") %>
      <div id="streams-container">
        &nbsp;
      </div>
    </div>

    <div id="stream-manager">
      <%- include("streamManagerModal") %>
    </div>    

    <%- include("newStreamTemplate") %>
    <%- include("psodModal") %>
  
    <script src="/js/pwa.js"></script>

    <script type="text/javascript">
      window.addEventListener("DOMContentLoaded", (event) => {
        MT.streams.setStreams("<%= streamsFromParms %>"); // init local storage item.
        MT.streams.update();
      });

      const streamsModal = document.getElementById("streams-modal");

      streamsModal.addEventListener("show.bs.modal", (event) => {
        MT.manager.show();
      });

      streamsModal.addEventListener("shown.bs.modal", (event) => {
        MT.manager.shown();
      });

      streamsModal.addEventListener("hidden.bs.modal", (event) => {
        MT.manager.hidden();
      });

      document.getElementById("save-btn").addEventListener("click", (event) => {
        let streamsList = document.getElementsByClassName("streams-modal-table-tr");
        let streams = MT.streams.getStreams();
        let newStreams = [];
        const orderChangedElement = document.getElementById("order-changed");

        if (orderChangedElement.checked) {
          console.debug("Streams have been re-ordered. Resetting...");
          MT.streams.setStreams("");
          streams = MT.streams.getStreams(); // reload our streams.
        }

        Array.from(streamsList).forEach(element => {
          let streamName = element.dataset.streamName;
          newStreams.push(streamName);
        });

        MT.streams.setStreams(newStreams.join(","));
        MT.streams.update(orderChangedElement.checked);
        orderChangedElement.checked = "false";
      });

    </script>

    <script defer src="/js/all.min.js"></script>

    <%- include("analytics") %>
  </body>
</html>